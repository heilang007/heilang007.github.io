
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>thinkphp3.2.3支付宝双接口 - 开源中国技术博客</title>
	<meta name="author" content="Fan Jun">

	
	<meta name="description" content="thinkphp3.2.3支付宝双接口未完成只能支付成功其他功能未完成 PayController.class.php 文件 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="开源中国技术博客" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">开源中国技术博客</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/php">PHP</a></li>
	<li><a href="/MYSQL">MySQL</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/php">PHP</a></li>
	<li><a href="/MYSQL">MySQL</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.baidu.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:heilang007.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.baidu.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:heilang007.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="page">
    
    <h1 class="title">thinkphp3.2.3支付宝双接口</h1>
    
    <div class="entry-content"><h1>thinkphp3.2.3支付宝双接口未完成只能支付成功其他功能未完成</h1>

<h2>PayController.class.php 文件</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>/*+++++++++++
</span><span class='line'>++
</span><span class='line'>++  2015-4-4 下午11:33:15
</span><span class='line'>++
</span><span class='line'>++++++++++++*/
</span><span class='line'>
</span><span class='line'>namespace Home\Controller;
</span><span class='line'>
</span><span class='line'>use Think\Controller;
</span><span class='line'>
</span><span class='line'>class PayController extends Controller {
</span><span class='line'>      public function _initialize(){
</span><span class='line'>        import('Org.Alipay.Corefunction');
</span><span class='line'>        import('Org.Alipay.Md5function');
</span><span class='line'>        import('Org.Alipay.Notify');
</span><span class='line'>        import('Org.Alipay.Submit');
</span><span class='line'>           //验证用户是否登录的代码
</span><span class='line'>          // echo 'this is _initialize';
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>    public function index(){
</span><span class='line'>        dump(C('alipay.notify_url'));
</span><span class='line'>        dump(C('alipay.return_url'));
</span><span class='line'>        $this-&gt;display();
</span><span class='line'>    }
</span><span class='line'>    /**************************请求参数**************************/
</span><span class='line'>    ///////////alipayapi.php
</span><span class='line'>    public function alipayapi(){
</span><span class='line'>    //支付类型
</span><span class='line'>    /* *
</span><span class='line'> * 功能：标准双接口接入页
</span><span class='line'> * 版本：3.3
</span><span class='line'> * 修改日期：2012-07-23
</span><span class='line'> * 说明：
</span><span class='line'> * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
</span><span class='line'> * 该代码仅供学习和研究支付宝接口使用，只是提供一个参考。
</span><span class='line'>
</span><span class='line'> *************************注意*************************
</span><span class='line'> * 如果您在接口集成过程中遇到问题，可以按照下面的途径来解决
</span><span class='line'> * 1、商户服务中心（https://b.alipay.com/support/helperApply.htm?action=consultationApply），提交申请集成协助，我们会有专业的技术工程师主动联系您协助解决
</span><span class='line'> * 2、商户帮助中心（http://help.alipay.com/support/232511-16307/0-16307.htm?sh=Y&info_type=9）
</span><span class='line'> * 3、支付宝论坛（http://club.alipay.com/read-htm-tid-8681712.html）
</span><span class='line'> * 如果不想使用扩展功能请把扩展功能参数赋空值。
</span><span class='line'> */
</span><span class='line'>
</span><span class='line'>//require_once("alipay.config.php");
</span><span class='line'>//require_once("lib/alipay_submit.class.php");
</span><span class='line'>
</span><span class='line'>/**************************请求参数**************************/
</span><span class='line'>        $alipay_config=C('alipay_config');
</span><span class='line'>        //支付类型
</span><span class='line'>        $payment_type = "1";
</span><span class='line'>        //必填，不能修改
</span><span class='line'>        //服务器异步通知页面路径
</span><span class='line'>        $notify_url = C('alipay.notify_url');
</span><span class='line'>        //需http://格式的完整路径，不能加?id=123这类自定义参数
</span><span class='line'>
</span><span class='line'>        //页面跳转同步通知页面路径
</span><span class='line'>        $return_url = C('alipay.return_url');
</span><span class='line'>        //需http://格式的完整路径，不能加?id=123这类自定义参数，不能写成http://localhost/
</span><span class='line'>
</span><span class='line'>        //商户订单号
</span><span class='line'>        $out_trade_no = $_POST['WIDout_trade_no'];
</span><span class='line'>        //商户网站订单系统中唯一订单号，必填
</span><span class='line'>
</span><span class='line'>        //订单名称
</span><span class='line'>        $subject = $_POST['WIDsubject'];
</span><span class='line'>        //必填
</span><span class='line'>
</span><span class='line'>        //付款金额
</span><span class='line'>        $price = $_POST['WIDprice'];
</span><span class='line'>        //必填
</span><span class='line'>
</span><span class='line'>        //商品数量
</span><span class='line'>        $quantity = "1";
</span><span class='line'>        //必填，建议默认为1，不改变值，把一次交易看成是一次下订单而非购买一件商品
</span><span class='line'>        //物流费用
</span><span class='line'>        $logistics_fee = "0.00";
</span><span class='line'>        //必填，即运费
</span><span class='line'>        //物流类型
</span><span class='line'>        $logistics_type = "EXPRESS";
</span><span class='line'>        //必填，三个值可选：EXPRESS（快递）、POST（平邮）、EMS（EMS）
</span><span class='line'>        //物流支付方式
</span><span class='line'>        $logistics_payment = "SELLER_PAY";
</span><span class='line'>        //必填，两个值可选：SELLER_PAY（卖家承担运费）、BUYER_PAY（买家承担运费）
</span><span class='line'>        //订单描述
</span><span class='line'>
</span><span class='line'>        $body = $_POST['WIDbody'];
</span><span class='line'>        //商品展示地址
</span><span class='line'>        $show_url = $_POST['WIDshow_url'];
</span><span class='line'>        //需以http://开头的完整路径，如：http://www.商户网站.com/myorder.html
</span><span class='line'>
</span><span class='line'>        //收货人姓名
</span><span class='line'>        $receive_name = $_POST['WIDreceive_name'];
</span><span class='line'>        //如：张三
</span><span class='line'>
</span><span class='line'>        //收货人地址
</span><span class='line'>        $receive_address = $_POST['WIDreceive_address'];
</span><span class='line'>        //如：XX省XXX市XXX区XXX路XXX小区XXX栋XXX单元XXX号
</span><span class='line'>
</span><span class='line'>        //收货人邮编
</span><span class='line'>        $receive_zip = $_POST['WIDreceive_zip'];
</span><span class='line'>        //如：123456
</span><span class='line'>
</span><span class='line'>        //收货人电话号码
</span><span class='line'>        $receive_phone = $_POST['WIDreceive_phone'];
</span><span class='line'>        //如：0571-88158090
</span><span class='line'>
</span><span class='line'>        //收货人手机号码
</span><span class='line'>        $receive_mobile = $_POST['WIDreceive_mobile'];
</span><span class='line'>        //如：13312341234
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>/************************************************************/
</span><span class='line'>
</span><span class='line'>//构造要请求的参数数组，无需改动
</span><span class='line'>$parameter = array(
</span><span class='line'>        "service" =&gt; "trade_create_by_buyer",
</span><span class='line'>        "partner" =&gt; trim($alipay_config['partner']),
</span><span class='line'>        "seller_email" =&gt; trim($alipay_config['seller_email']),
</span><span class='line'>        "payment_type"    =&gt; $payment_type,
</span><span class='line'>        "notify_url"    =&gt; $notify_url,
</span><span class='line'>        "return_url"    =&gt; $return_url,
</span><span class='line'>        "out_trade_no"    =&gt; $out_trade_no,
</span><span class='line'>        "subject"    =&gt; $subject,
</span><span class='line'>        "price"    =&gt; $price,
</span><span class='line'>        "quantity"    =&gt; $quantity,
</span><span class='line'>        "logistics_fee"    =&gt; $logistics_fee,
</span><span class='line'>        "logistics_type"    =&gt; $logistics_type,
</span><span class='line'>        "logistics_payment"    =&gt; $logistics_payment,
</span><span class='line'>        "body"    =&gt; $body,
</span><span class='line'>        "show_url"    =&gt; $show_url,
</span><span class='line'>        "receive_name"    =&gt; $receive_name,
</span><span class='line'>        "receive_address"    =&gt; $receive_address,
</span><span class='line'>        "receive_zip"    =&gt; $receive_zip,
</span><span class='line'>        "receive_phone"    =&gt; $receive_phone,
</span><span class='line'>        "receive_mobile"    =&gt; $receive_mobile,
</span><span class='line'>        "_input_charset"    =&gt; trim(strtolower($alipay_config['input_charset']))
</span><span class='line'>);
</span><span class='line'>
</span><span class='line'>//建立请求
</span><span class='line'>$alipaySubmit = new \AlipaySubmit($alipay_config);
</span><span class='line'>$html_text = $alipaySubmit-&gt;buildRequestForm($parameter,"get", "确定支付");
</span><span class='line'>echo $html_text;
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>////////////////////////////////notify_url.php
</span><span class='line'>    public function notifyurl(){
</span><span class='line'>    $alipay_config=C('alipay_config');
</span><span class='line'>    /* *
</span><span class='line'> * 功能：支付宝服务器异步通知页面
</span><span class='line'> * 版本：3.3
</span><span class='line'> * 日期：2012-07-23
</span><span class='line'> * 说明：
</span><span class='line'> * 以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。
</span><span class='line'> * 该代码仅供学习和研究支付宝接口使用，只是提供一个参考。
</span><span class='line'>
</span><span class='line'>
</span><span class='line'> *************************页面功能说明*************************
</span><span class='line'> * 创建该页面文件时，请留心该页面文件中无任何HTML代码及空格。
</span><span class='line'> * 该页面不能在本机电脑测试，请到服务器上做测试。请确保外部可以访问该页面。
</span><span class='line'> * 该页面调试工具请使用写文本函数logResult，该函数已被默认关闭，见alipay_notify_class.php中的函数verifyNotify
</span><span class='line'> * 如果没有收到该页面返回的 success 信息，支付宝会在24小时内按一定的时间策略重发通知
</span><span class='line'> 
</span><span class='line'> * 如何判断该笔交易是通过即时到帐方式付款还是通过担保交易方式付款？
</span><span class='line'> * 
</span><span class='line'> * 担保交易的交易状态变化顺序是：等待买家付款→买家已付款，等待卖家发货→卖家已发货，等待买家收货→买家已收货，交易完成
</span><span class='line'> * 即时到帐的交易状态变化顺序是：等待买家付款→交易完成
</span><span class='line'> * 
</span><span class='line'> * 每当收到支付宝发来通知时，就可以获取到这笔交易的交易状态，并且商户需要利用商户订单号查询商户网站的订单数据，
</span><span class='line'> * 得到这笔订单在商户网站中的状态是什么，把商户网站中的订单状态与从支付宝通知中获取到的状态来做对比。
</span><span class='line'> * 如果商户网站中目前的状态是等待买家付款，而从支付宝通知获取来的状态是买家已付款，等待卖家发货，那么这笔交易买家是用担保交易方式付款的
</span><span class='line'> * 如果商户网站中目前的状态是等待买家付款，而从支付宝通知获取来的状态是交易完成，那么这笔交易买家是用即时到帐方式付款的
</span><span class='line'> */
</span><span class='line'>
</span><span class='line'>//require_once("alipay.config.php");
</span><span class='line'>//require_once("lib/alipay_notify.class.php");
</span><span class='line'>
</span><span class='line'>//计算得出通知验证结果
</span><span class='line'>$alipayNotify = new \AlipayNotify($alipay_config);
</span><span class='line'>$verify_result = $alipayNotify-&gt;verifyNotify();
</span><span class='line'>
</span><span class='line'>if($verify_result) {//验证成功
</span><span class='line'>    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
</span><span class='line'>    //请在这里加上商户的业务逻辑程序代
</span><span class='line'>
</span><span class='line'>    
</span><span class='line'>    //——请根据您的业务逻辑来编写程序（以下代码仅作参考）——
</span><span class='line'>    
</span><span class='line'>    //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表
</span><span class='line'>    
</span><span class='line'>    //商户订单号
</span><span class='line'>    $out_trade_no = $_POST['out_trade_no'];
</span><span class='line'>    //支付宝交易号
</span><span class='line'>    $trade_no = $_POST['trade_no'];
</span><span class='line'>    //交易状态
</span><span class='line'>    $trade_status = $_POST['trade_status'];
</span><span class='line'>    if($_POST['trade_status'] == 'WAIT_BUYER_PAY') {
</span><span class='line'>    //该判断表示买家已在支付宝交易管理中产生了交易记录，但没有付款
</span><span class='line'>    //判断该笔订单是否在商户网站中已经做过处理
</span><span class='line'>            //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
</span><span class='line'>            //如果有做过处理，不执行商户的业务程序
</span><span class='line'>        echo "success";        //请不要修改或删除
</span><span class='line'>        //调试用，写文本函数记录程序运行情况是否正常
</span><span class='line'>        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
</span><span class='line'>    }
</span><span class='line'>    else if($_POST['trade_status'] == 'WAIT_SELLER_SEND_GOODS') {
</span><span class='line'>    //该判断表示买家已在支付宝交易管理中产生了交易记录且付款成功，但卖家没有发货
</span><span class='line'>    
</span><span class='line'>        //判断该笔订单是否在商户网站中已经做过处理
</span><span class='line'>            //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
</span><span class='line'>            //如果有做过处理，不执行商户的业务程序
</span><span class='line'>            
</span><span class='line'>        echo "success";        //请不要修改或删除
</span><span class='line'>
</span><span class='line'>        //调试用，写文本函数记录程序运行情况是否正常
</span><span class='line'>        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
</span><span class='line'>    }
</span><span class='line'>    else if($_POST['trade_status'] == 'WAIT_BUYER_CONFIRM_GOODS') {
</span><span class='line'>    //该判断表示卖家已经发了货，但买家还没有做确认收货的操作
</span><span class='line'>    
</span><span class='line'>        //判断该笔订单是否在商户网站中已经做过处理
</span><span class='line'>            //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
</span><span class='line'>            //如果有做过处理，不执行商户的业务程序
</span><span class='line'>            
</span><span class='line'>        echo "success";        //请不要修改或删除
</span><span class='line'>
</span><span class='line'>        //调试用，写文本函数记录程序运行情况是否正常
</span><span class='line'>        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
</span><span class='line'>    }
</span><span class='line'>    else if($_POST['trade_status'] == 'TRADE_FINISHED') {
</span><span class='line'>    //该判断表示买家已经确认收货，这笔交易完成
</span><span class='line'>    
</span><span class='line'>        //判断该笔订单是否在商户网站中已经做过处理
</span><span class='line'>            //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
</span><span class='line'>            //如果有做过处理，不执行商户的业务程序
</span><span class='line'>            
</span><span class='line'>        echo "success";        //请不要修改或删除
</span><span class='line'>
</span><span class='line'>        //调试用，写文本函数记录程序运行情况是否正常
</span><span class='line'>        //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
</span><span class='line'>    }
</span><span class='line'>    else {
</span><span class='line'>        //其他状态判断
</span><span class='line'>        echo "success";
</span><span class='line'>
</span><span class='line'>        //调试用，写文本函数记录程序运行情况是否正常
</span><span class='line'>        //logResult ("这里写入想要调试的代码变量值，或其他运行的结果记录");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    //——请根据您的业务逻辑来编写程序（以上代码仅作参考）——
</span><span class='line'>    
</span><span class='line'>    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
</span><span class='line'>}
</span><span class='line'>else {
</span><span class='line'>    //验证失败
</span><span class='line'>    echo "fail";
</span><span class='line'>
</span><span class='line'>    //调试用，写文本函数记录程序运行情况是否正常
</span><span class='line'>    //logResult("这里写入想要调试的代码变量值，或其他运行的结果记录");
</span><span class='line'>}
</span><span class='line'>    
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>/////////////return_url.php
</span><span class='line'>   public function returnurl(){
</span><span class='line'>       $alipay_config=C('alipay_config');
</span><span class='line'>       $alipayNotify = new \AlipayNotify($alipay_config);
</span><span class='line'>       $verify_result = $alipayNotify-&gt;verifyReturn();
</span><span class='line'>     if($verify_result) {//验证成功
</span><span class='line'>    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
</span><span class='line'>    //请在这里加上商户的业务逻辑程序代码
</span><span class='line'>    
</span><span class='line'>    //——请根据您的业务逻辑来编写程序（以下代码仅作参考）——
</span><span class='line'>    //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表
</span><span class='line'>
</span><span class='line'>    //商户订单号
</span><span class='line'>
</span><span class='line'>    $out_trade_no = $_GET['out_trade_no'];
</span><span class='line'>
</span><span class='line'>    //支付宝交易号
</span><span class='line'>
</span><span class='line'>    $trade_no = $_GET['trade_no'];
</span><span class='line'>
</span><span class='line'>    //交易状态
</span><span class='line'>    $trade_status = $_GET['trade_status'];
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    if($_GET['trade_status'] == 'WAIT_SELLER_SEND_GOODS') {
</span><span class='line'>        //判断该笔订单是否在商户网站中已经做过处理
</span><span class='line'>            //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
</span><span class='line'>            //如果有做过处理，不执行商户的业务程序
</span><span class='line'>    }
</span><span class='line'>    else if($_GET['trade_status'] == 'TRADE_FINISHED') {
</span><span class='line'>        //判断该笔订单是否在商户网站中已经做过处理
</span><span class='line'>            //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
</span><span class='line'>            //如果有做过处理，不执行商户的业务程序
</span><span class='line'>    }
</span><span class='line'>    else {
</span><span class='line'>      echo "trade_status=".$_GET['trade_status'];
</span><span class='line'>    }
</span><span class='line'>        
</span><span class='line'>    echo "&lt;meta http-equiv='content-type' content='text/html; charset=utf-8'&gt;验证成功&lt;br /&gt;";
</span><span class='line'>    echo "支付宝订单编号=".$trade_no;
</span><span class='line'>
</span><span class='line'>    //——请根据您的业务逻辑来编写程序（以上代码仅作参考）——
</span><span class='line'>    
</span><span class='line'>    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
</span><span class='line'>}
</span><span class='line'>    else {
</span><span class='line'>    //验证失败
</span><span class='line'>    //如要调试，请看alipay_notify.php页面的verifyReturn函数
</span><span class='line'>    echo "验证失败";
</span><span class='line'>}
</span><span class='line'>}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>?&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>config.php</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>return array(
</span><span class='line'>    //'配置项'=&gt;'配置值'
</span><span class='line'>    'DB_TYPE'               =&gt;  'mysqli',     // 数据库类型
</span><span class='line'>    'DB_HOST'               =&gt;  ' ', // 服务器地址
</span><span class='line'>    'DB_NAME'               =&gt;  ' ',          // 数据库名
</span><span class='line'>    'DB_USER'               =&gt;  ' ',      // 用户名
</span><span class='line'>    'DB_PWD'                =&gt;  ' ',          // 密码
</span><span class='line'>    'DB_PORT'               =&gt;  '3306',        // 端口
</span><span class='line'>    'DB_CHARSET'            =&gt;  'utf8',      // 数据库编码默认采用utf8
</span><span class='line'>    'DB_PREFIX'             =&gt;  'wt_',
</span><span class='line'>    'ERROR_MESSAGE'         =&gt;  '页面错误!请稍后再试~~~',
</span><span class='line'>    'SHOW_ERROR_MSG'        =&gt;  true,
</span><span class='line'>    'URL_CASE_INSENSITIVE'  =&gt;  true,
</span><span class='line'>    'LAYOUT_NO'             =&gt;  TRUE ,
</span><span class='line'>    'URL_MODEL'             =&gt; 2,
</span><span class='line'>    'alipay_config'=&gt;array(
</span><span class='line'>    'partner'              =&gt;'11',
</span><span class='line'>    'key'                  =&gt;' ',
</span><span class='line'>    'seller_email'           =&gt; '1',
</span><span class='line'>    'sign_type'            =&gt; strtoupper('MD5'),
</span><span class='line'>    'input_charset'        =&gt; strtolower('utf-8'),
</span><span class='line'>    'cacert'               =&gt; getcwd().'/cacert.pem',
</span><span class='line'>    'transport'            =&gt; 'http',
</span><span class='line'>    ),
</span><span class='line'>    'alipay'              =&gt;array(
</span><span class='line'>                  //这里是异步通知页面url，提交到项目的Pay控制器的notifyurl方法；
</span><span class='line'>                  'notify_url'=&gt;'http://www.wtwk.net/home/pay/notifyurl',
</span><span class='line'>                  //这里是页面跳转通知url，提交到项目的Pay控制器的returnurl方法；
</span><span class='line'>                  'return_url'=&gt;'http://www.wtwk.net/home/pay/returnurl',
</span><span class='line'>                  //支付成功跳转到的页面，我这里跳转到项目的User控制器，myorder方法，并传参payed（已支付列表）
</span><span class='line'>                  'successpage'=&gt;'User/myorder?ordtype=payed',
</span><span class='line'>                   //支付失败跳转到的页面，我这里跳转到项目的User控制器，myorder方法，并传参unpay（未支付列表）
</span><span class='line'>                  'errorpage'=&gt;'User/myorder?ordtype=unpay',
</span><span class='line'>    ),
</span><span class='line'>);
</span><span class='line'>    
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://www.thinkphp.cn/Uploads/editor/2015-04-05/5520f93b29283.png">image</a></p>

<p><a href="http://www.thinkphp.cn/Uploads/editor/2015-04-05/5520f8850eb9a.png">image</a></p>
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
		
	</div>
	
</div>



</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Fan Jun

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>